{% extends 'assignments/base.html' %}

{% block title %}Umpire Payments - Umpire Assigner{% endblock %}

{% block content %}
<h2>Umpire Payment Tracking</h2>

<style>
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: bold;
    border-radius: 4px;
    margin-left: 0.25rem;
}

.badge-info {
    background-color: #3498db;
    color: white;
}

.badge-warning {
    background-color: #f39c12;
    color: white;
}

.badge-success {
    background-color: #27ae60;
    color: white;
}

.badge-danger {
    background-color: #e74c3c;
    color: white;
}

.badge-secondary {
    background-color: #95a5a6;
    color: white;
}
</style>

<!-- Weekly Payment Summary Grid -->
<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h3 style="color: white;">Weekly Payment Summary</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                <th style="color: white; padding: 0.75rem; text-align: left; background: transparent; border: none;">Week</th>
                <th style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">Games</th>
                <th style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">Assignments</th>
                <th style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">Umpires</th>
                <th style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none;">Projected Total</th>
                <th style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none;">Actual Earned</th>
                <th style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none;">Amount Paid</th>
                <th style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none;">Amount Due</th>
            </tr>
        </thead>
        <tbody>
            {% for week in weekly_totals %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                <td style="color: white; padding: 0.75rem; background: transparent; border: none;">{{ week.week_start|date:"M d" }} - {{ week.week_end|date:"M d, Y" }}</td>
                <td style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">{{ week.games_count }}</td>
                <td style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">{{ week.assignments_count }}</td>
                <td style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">{{ week.umpires_count }}</td>
                <td style="color: white; padding: 0.75rem; text-align: right; font-weight: bold; background: transparent; border: none;">${{ week.total_projected|floatformat:2 }}</td>
                <td style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none;">${{ week.total_actual|floatformat:2 }}</td>
                <td style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none; color: #90EE90;">${{ week.amount_paid|floatformat:2 }}</td>
                <td style="color: white; padding: 0.75rem; text-align: right; background: transparent; border: none; color: #FFB6C1;">${{ week.amount_due|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="color: white; padding: 0.75rem; text-align: center; background: transparent; border: none;">No payment data available yet</td>
            </tr>
            {% endfor %}
        </tbody>
        {% if weekly_totals %}
        <tfoot>
            <tr style="border-top: 2px solid rgba(255,255,255,0.3); font-weight: bold;">
                <td style="color: white; padding: 0.75rem; background: transparent; border: none;">SEASON TOTALS</td>
                <td colspan="3" style="color: white; padding: 0.75rem; background: transparent; border: none;"></td>
                <td style="color: white; padding: 0.75rem; text-align: right; font-size: 1.2rem; background: transparent; border: none;">${{ grand_total_owed|floatformat:2 }}</td>
                <td style="color: white; padding: 0.75rem; background: transparent; border: none;"></td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
</div>

<!-- Grand Totals Summary -->
<div class="card" style="background-color: #f8f9fa;">
    <h3 style="margin-bottom: 1rem;">Payment Summary</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
        <div style="text-align: center;">
            <h4 style="color: #495057; margin: 0; font-size: 0.9rem;">Projected<br/>(Scheduled Games)</h4>
            <p style="font-size: 1.8rem; font-weight: bold; color: #3498db; margin: 0.5rem 0;">
                ${{ grand_total_projected|floatformat:2 }}
            </p>
        </div>
        <div style="text-align: center;">
            <h4 style="color: #495057; margin: 0; font-size: 0.9rem;">Actual Earned<br/>(Worked Games)</h4>
            <p style="font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin: 0.5rem 0;">
                ${{ grand_total_actual|floatformat:2 }}
            </p>
        </div>
        <div style="text-align: center;">
            <h4 style="color: #495057; margin: 0; font-size: 0.9rem;">Total Paid</h4>
            <p style="font-size: 1.8rem; font-weight: bold; color: #27ae60; margin: 0.5rem 0;">
                ${{ grand_total_paid|floatformat:2 }}
            </p>
        </div>
        <div style="text-align: center;">
            <h4 style="color: #495057; margin: 0; font-size: 0.9rem;">Due Now<br/>(Worked - Paid)</h4>
            <p style="font-size: 1.8rem; font-weight: bold; color: #e74c3c; margin: 0.5rem 0;">
                ${{ grand_total_unpaid_actual|floatformat:2 }}
            </p>
        </div>
        <div style="text-align: center; border-left: 2px solid #dee2e6; padding-left: 1rem;">
            <h4 style="color: #495057; margin: 0; font-size: 0.9rem;">Total Expected<br/>(Projected + Due)</h4>
            <p style="font-size: 1.8rem; font-weight: bold; color: #9b59b6; margin: 0.5rem 0;">
                ${{ grand_total_unpaid_projected|floatformat:2 }}
            </p>
        </div>
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6; font-size: 0.85rem; color: #6c757d;">
        <strong>Note:</strong> "Projected" includes payments for scheduled games not yet played. "Actual Earned" only includes games marked as completed with umpires confirmed as worked.
    </div>
</div>

<div class="card">
    <h3>Individual Umpire Summary</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Umpire</th>
                <th>Status</th>
                <th class="text-right">Projected<br/><small>(Scheduled)</small></th>
                <th class="text-right">Actual Earned<br/><small>(Worked)</small></th>
                <th class="text-right">Total Paid</th>
                <th class="text-right">Due Now</th>
                <th class="text-right">Total Expected</th>
            </tr>
        </thead>
        <tbody>
            {% for data in umpire_data %}
            <tr>
                <td>
                    {{ data.umpire }}
                    {% if data.umpire.patched %}
                        <span class="badge badge-success">Patched</span>
                    {% endif %}
                    {% if data.umpire.adult %}
                        <span class="badge badge-info">Adult</span>
                    {% endif %}
                </td>
                <td>
                    {% if data.actual_unpaid > 0 %}
                        <span class="badge badge-warning">Payment Due</span>
                    {% elif data.projected_total > 0 %}
                        <span class="badge badge-info">Games Scheduled</span>
                    {% else %}
                        <span class="badge badge-success">Current</span>
                    {% endif %}
                </td>
                <td class="text-right" style="color: #3498db;">${{ data.projected_total|floatformat:2 }}</td>
                <td class="text-right">${{ data.actual_owed|floatformat:2 }}</td>
                <td class="text-right" style="color: #27ae60;">${{ data.total_paid|floatformat:2 }}</td>
                <td class="text-right">
                    {% if data.actual_unpaid > 0 %}
                        <strong style="color: #e74c3c;">${{ data.actual_unpaid|floatformat:2 }}</strong>
                    {% else %}
                        $0.00
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if data.projected_unpaid > 0 %}
                        <strong style="color: #9b59b6;">${{ data.projected_unpaid|floatformat:2 }}</strong>
                    {% else %}
                        $0.00
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for data in umpire_data %}
{% if data.actual_unpaid > 0 or data.projected_total > 0 %}
<div class="card">
    <h3>{{ data.umpire }} - Payment Details</h3>
    
    <div class="mb-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        <div>
            <strong>Projected Total:</strong> <span style="color: #3498db;">${{ data.projected_total|floatformat:2 }}</span>
        </div>
        <div>
            <strong>Actual Earned:</strong> ${{ data.actual_owed|floatformat:2 }}
        </div>
        <div>
            <strong>Amount Paid:</strong> <span style="color: #27ae60;">${{ data.total_paid|floatformat:2 }}</span>
        </div>
        <div>
            <strong>Balance Due:</strong> <span style="color: #e74c3c; font-weight: bold;">${{ data.actual_unpaid|floatformat:2 }}</span>
        </div>
    </div>
    
    {% if data.assignments_by_date %}
    <h4>Assignments by Date</h4>
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="table">
            <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Field</th>
                    <th>Game</th>
                    <th>Position</th>
                    <th>Status</th>
                    <th class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for date, date_info in data.assignments_by_date.items %}
                    {% for assignment in date_info.assignments %}
                    <tr {% if forloop.first %}style="border-top: 3px solid #3498db;"{% endif %}>
                        {% if forloop.first %}
                        <td rowspan="{{ date_info.assignments|length }}" style="vertical-align: top; font-weight: bold; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">
                            {{ date|date:"M d, Y" }}<br/>
                            <small style="color: #6c757d;">{{ date|date:"l" }}</small>
                        </td>
                        {% endif %}
                        <td>{{ assignment.game.get_time_display }}</td>
                        <td>{{ assignment.game.get_field_display }}</td>
                        <td>{{ assignment.game.away_team }} vs {{ assignment.game.home_team }}</td>
                        <td>
                            <span class="badge {% if assignment.position == 'plate' %}badge-info{% elif assignment.position == 'base' %}badge-warning{% else %}badge-success{% endif %}">
                                {{ assignment.get_position_display }}
                            </span>
                        </td>
                        <td>
                            {% if assignment.worked_status == 'worked' %}
                                <span class="badge badge-success">Worked</span>
                            {% elif assignment.worked_status == 'assigned' %}
                                <span class="badge badge-info">Scheduled</span>
                            {% elif assignment.worked_status == 'no_show' %}
                                <span class="badge badge-danger">No Show</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ assignment.get_worked_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right">
                            {% if assignment.worked_status == 'worked' %}
                                <strong style="color: #27ae60;">${{ assignment.pay_amount|floatformat:2 }}</strong>
                            {% elif assignment.worked_status == 'assigned' %}
                                <span style="color: #3498db;">${{ assignment.pay_amount|floatformat:2 }}*</span>
                            {% else %}
                                <span style="color: #e74c3c; text-decoration: line-through;">$0.00</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if date_info.assignments|length > 1 %}
                    <tr style="background-color: #f0f4f8; border-top: 1px solid #dee2e6;">
                        <td></td>
                        <td colspan="5" class="text-right" style="padding: 0.5rem; font-weight: bold;">Daily Total:</td>
                        <td class="text-right" style="padding: 0.5rem;">
                            {% if date_info.total_earned > 0 %}
                                <strong style="color: #27ae60;">${{ date_info.total_earned|floatformat:2 }}</strong>
                            {% endif %}
                            {% if date_info.total_projected > 0 %}
                                <span style="color: #3498db; font-weight: bold;">+${{ date_info.total_projected|floatformat:2 }}*</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% if not forloop.last %}
                    <tr>
                        <td colspan="7" style="padding: 0; height: 10px; background-color: #ffffff;"></td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">
            * Projected payment (game not yet worked)
        </div>
    </div>
    {% endif %}
    
    {% if data.payment_history %}
    <h4>Payment History</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Period</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Paid Date</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in data.payment_history %}
            <tr>
                <td>{{ payment.period_start|date:"M d" }} - {{ payment.period_end|date:"M d, Y" }}</td>
                <td>${{ payment.amount|floatformat:2 }}</td>
                <td>
                    {% if payment.paid %}
                        <span class="badge badge-success">Paid</span>
                    {% else %}
                        <span class="badge badge-danger">Unpaid</span>
                    {% endif %}
                </td>
                <td>
                    {% if payment.paid_date %}
                        {{ payment.paid_date|date:"M d, Y" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endif %}
{% endfor %}
{% endblock %}